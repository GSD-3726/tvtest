name: Update MIGU Live Channels

on:
  schedule:
    # æ¯2å°æ—¶è¿è¡Œä¸€æ¬¡ï¼ˆUTCæ—¶é—´ï¼Œå¯¹åº”åŒ—äº¬æ—¶é—´+8å°æ—¶ï¼Œå³åŒ—äº¬æ—¶é—´8/10/12...ç‚¹æ‰§è¡Œï¼‰
    - cron: '0 */2 * * *'
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  push:  # ä»£ç å˜æ›´æ—¶è¿è¡Œ
    paths:
      - '**.py'
    branches: [ main, master ]

jobs:
  update-channels:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # æ‹‰å–å®Œæ•´æäº¤å†å²ï¼Œæ”¯æŒåˆå¹¶/å˜åŸºï¼ˆå¿…é¡»é…ç½®ï¼‰

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'  # ç¼“å­˜ä¾èµ–ï¼Œæå‡è¿è¡Œé€Ÿåº¦

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests

    - name: é…ç½®ç³»ç»Ÿæ—¶åŒºä¸ºåŒ—äº¬æ—¶é—´ï¼ˆæ ¸å¿ƒï¼šæäº¤æ—¶é—´/æ—¥å¿—æ—¶é—´å‡ä¸ºåŒ—äº¬æ—¶é—´ï¼‰
      run: sudo timedatectl set-timezone Asia/Shanghai

    - name: Run MIGU channel updaterï¼ˆè„šæœ¬åæ”¹ä¸ºmain.pyï¼Œä¸¥æ ¼æŒ‰è¦æ±‚ï¼‰
      run: |
        python main.py

    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # ä»…æ£€æŸ¥ç›®æ ‡è¾“å‡ºæ–‡ä»¶å˜æ›´ï¼Œé¿å…æ— å…³ä¿®æ”¹è§¦å‘æäº¤
        if git diff --quiet HEAD -- migu.m3u migu.txt; then
          echo "âœ… No changes detected in migu.m3u/migu.txt, skip commit"
        else
          git add migu.m3u migu.txt
          # æäº¤ä¿¡æ¯å¸¦åŒ—äº¬æ—¶é—´ï¼ˆæ—¶åˆ†ç§’ï¼‰ï¼Œæ›´ç²¾å‡†
          git commit -m "ğŸ¤– Auto-update: MIGUç›´æ’­æº $(date +'%Y-%m-%d %H:%M:%S')"
          # æ ¸å¿ƒè§£å†³æ¨é€è¢«æ‹’ï¼šæ‹‰å–è¿œç¨‹æœ€æ–°å˜æ›´+è‡ªåŠ¨åˆå¹¶ï¼Œå†æ¨é€
          git pull origin main --rebase --autostash
          git push origin main
          echo "âœ… Push MIGU live channel updates successfullyï¼ˆåŒ—äº¬æ—¶é—´ï¼‰"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  
