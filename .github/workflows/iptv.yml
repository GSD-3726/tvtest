name: Update MIGU Live Channels

on:
  schedule:
    # æ¯2å°æ—¶è¿è¡Œä¸€æ¬¡ï¼ˆUTCæ—¶é—´ï¼Œå¯¹åº”åŒ—äº¬æ—¶é—´+8å°æ—¶ï¼Œå³åŒ—äº¬æ—¶é—´8/10/12...ç‚¹æ‰§è¡Œï¼‰
    - cron: '0 */2 * * *'
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  push:  # ä»£ç å˜æ›´æ—¶è¿è¡Œ
    paths:
      - '**.py'
    branches: [ main, master ]

jobs:
  update-channels:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # æ‹‰å–å®Œæ•´æäº¤å†å²ï¼Œæ”¯æŒåˆå¹¶/å˜åŸºï¼ˆå¿…é¡»é…ç½®ï¼‰

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'  # ç¼“å­˜ä¾èµ–ï¼Œæå‡è¿è¡Œé€Ÿåº¦

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests

    - name: é…ç½®ç³»ç»Ÿæ—¶åŒºä¸ºåŒ—äº¬æ—¶é—´ï¼ˆæ ¸å¿ƒï¼šæäº¤æ—¶é—´/æ—¥å¿—æ—¶é—´å‡ä¸ºåŒ—äº¬æ—¶é—´ï¼‰
      run: sudo timedatectl set-timezone Asia/Shanghai

    - name: Run MIGU channel updaterï¼ˆè„šæœ¬åæ”¹ä¸ºmain.pyï¼Œä¸¥æ ¼æŒ‰è¦æ±‚ï¼‰
      run: |
        python main.py

    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        # åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å˜åŒ–
        if git diff --quiet HEAD -- migu.m3u migu.txt; then
          echo "âœ… No changes detected, skip commit"
          exit 0
        fi

        git add migu.m3u migu.txt
        git commit -m "ğŸ¤– Auto-update: MIGUç›´æ’­æº $(date +'%Y-%m-%d %H:%M:%S')"

        # æ¨é€åˆ° GitHubï¼ˆé€‚é…main/masteråˆ†æ”¯ï¼Œå¢å¼ºé€šç”¨æ€§ï¼‰
        git pull origin ${{ github.ref_name }} --rebase --autostash
        git push origin ${{ github.ref_name }}

        echo "âœ… GitHub push success"

        # ---------- æ¨é€åˆ° Gitee ----------
        git remote remove gitee || true  # ç§»é™¤å·²æœ‰giteeè¿œç¨‹ï¼ˆé¿å…é‡å¤æ·»åŠ æŠ¥é”™ï¼‰
        git remote add gitee https://oauth2:${{ secrets.GITEE_TOKEN }}@gitee.com/bmg369/test.git

        # å¼ºåˆ¶æ¨é€åˆ°Giteeå¯¹åº”åˆ†æ”¯ï¼Œé€‚é…main/master
        git push gitee ${{ github.ref_name }} --force

        echo "âœ… Gitee sync success"
