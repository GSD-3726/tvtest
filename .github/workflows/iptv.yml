name: 咪咕直播源自动爬取
on:
  # 定时触发：每2小时运行一次（UTC时间，对应国内+8小时，即8:00/10:00/12:00...）
  schedule:
    - cron: '0 */2 * * *'
  # 手动触发：仓库Actions页面可手动点击运行（方便测试）
  workflow_dispatch:
  # 可选：推代码到main/master分支时触发（测试用）
  push:
    branches: [ main, master ]

jobs:
  crawl-migu:
    runs-on: ubuntu-latest
    steps:
      # 步骤1：拉取仓库根目录的 main.py 等代码
      - name: 拉取仓库代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 拉取全历史，避免推送冲突

      # 步骤2：配置Python环境（兼容你的脚本，3.9稳定版）
      - name: 配置Python 3.9环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'  # 缓存依赖，加速运行

      # 步骤3：安装脚本唯一依赖 requests
      - name: 安装requests依赖
        run: |
          python -m pip install --upgrade pip
          pip install requests

      # 步骤4：运行根目录的 main.py 脚本（无需修改，完全匹配）
      - name: 执行爬取脚本生成 migu.txt
        run: python main.py
        continue-on-error: false  # 脚本运行失败则终止工作流

      # 步骤5：配置Git提交信息（机器人账号，无需修改）
      - name: 配置Git用户信息
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # 步骤6：自动提交并推送 migu.txt 到仓库
      - name: 推送最新 migu.txt 到仓库
        run: |
          git add migu.txt
          # 无文件变化时不报错，提交备注带运行时间
          git commit -m "Auto update migu.txt: $(date +'%Y-%m-%d %H:%M:%S UTC')" || true
          git push origin ${{ github.ref }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # 内置TOKEN，免手动配置
