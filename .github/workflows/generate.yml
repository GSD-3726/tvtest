name: Sync migu files to Gitee
# 仅在根目录的migu.m3u/migu.txt变更时触发，或手动触发
on:
  push:
    branches: [main, master]
    paths:  # 仅监听这两个文件的变更
      - 'migu.m3u'
      - 'migu.txt'
  workflow_dispatch:  # 手动触发，方便测试

jobs:
  sync-migu-files:
    runs-on: ubuntu-latest
    steps:
      # 步骤1：拉取GitHub仓库完整代码
      - name: Checkout GitHub Repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0  # 拉取完整历史，确保文件版本正确

      # 步骤2：仅提交migu.m3u和migu.txt（确保只同步这两个文件）
      - name: Commit migu files (if changed)
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          # 仅添加指定的两个文件，避免提交其他无关变更
          git add migu.m3u migu.txt
          # 无变更则跳过提交，避免Workflow失败
          git commit -m "Update migu.m3u/migu.txt via Actions" || echo "No changes to migu files"
          # 推回GitHub仓库（仅这两个文件的变更）
          git push "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/GSD-3726/tvtest.git" HEAD:${{ github.ref }}

      # 步骤3：同步这两个文件的变更到Gitee（修正无效参数，实现强制同步）
      - name: Sync migu files to Gitee (bmg369/test)
        uses: wearerequired/git-mirror-action@master
        env:
          GIT_TOKEN: ${{ secrets.GITEE_TOKEN }}
        with:
          source-repo: "https://github.com/GSD-3726/tvtest.git"
          destination-repo: "https://${{ secrets.GITEE_TOKEN }}@gitee.com/bmg369/test.git"
          # 核心修改：用args传递强制推送参数，替代无效的force-push
          args: "--force"  # 传递git push --force指令，实现强制同步
